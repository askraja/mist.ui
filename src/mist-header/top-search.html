<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="search-suggestions.html">

<dom-module id="top-search">
  <template>
    <style include="shared-styles">
      :host * {
        box-sizing: border-box;
        outline: none;
      }

      :host {
        outline: none;
        max-width: 800px;
        display: block;
        align-items: center;
        background-color: rgba(255,255,255,.15);
        height: 48px;
        border-radius: 4px;
        width: 100%;
        min-width: 48px;
        transition: all 10ms ease-in;
      }

      :host::content iron-icon {
        cursor: pointer;
        color: inherit;
      }
      
      #search iron-icon {
        align-self: center;
      }
      
      #search iron-icon[icon="search"] {
        margin-left: 8px;
        margin-right: 8px;
      }

      #search iron-icon[icon="close"] {
        margin-right: 8px;
        margin-left: 0;
      }

      #search input {
        font-size: 16px;
        color: #fff;
        width: 100%;
        height: 48px;
        line-height: 48px;
        border: 0;
        border-radius: 2px;
        -webkit-appearance: none;
        align-self: center;
        display: block;
        background-color: transparent;
        padding-right: 8px;
      }

      #search input:focus {
        outline: 0;
      }

      paper-icon-button {
          display: block;
          margin: 4px;
          float: right;
      }

      paper-icon-button.clear-filter {
          opacity: .5;
          transform: scale(.7);
          flex: none;
          margin-right: -10px;
      }

      #filterSelection paper-item {
          display: flex;
          flex-direction: row;
      }

      #filterSelection paper-item.hr-true:not(:last-of-type) {
          border-bottom: 1px solid #eee;
      }

      #filterSelection paper-item span {
          display: block;
          flex: 1;
      }

      .filters-sep {
          opacity: 0.32;
      }

      ::-webkit-input-placeholder {
        color: #fff !important;
      }

      ::-webkit-search-cancel-button {
        display: none;
      }
      paper-icon-button[icon='search'] {
        display: none;
      }

      @media screen and (max-width: 800px) {
        :host {
            background-color: transparent;
        }

        :host([overflow]) {
          background-color: rgba(255,255,255,1);
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          height: 56px;
          z-index: 99;
          border-radius: 0;
          transition: all 150ms ease-in;
        }

        :host([overflow]) paper-icon-button[icon='search'] {
            display: none;
            margin: 0;
            float: none;
        }

        #search {
          display: none;
          color: rgba(0,0,0,0.87);
          transform: translate(0,-30px);
          transition: all 10ms ease-in;
        }

        #search input {
          color: rgba(0,0,0,0.87); 
        }

        :host([overflow]) #search {
          display: flex;
          height: 56px;
          line-height: 56px;
          transition: all 150ms ease-in;
          transform: translate(0,0);
        }
      }
      @media screen and (min-width: 600px) and (max-width: 800px){
        :host([overflow]) {
          height: 64px;
        }
        :host([overflow]) #search {
          height: 64px;
          line-height: 64px;
        }
      }
      paper-menu-button {
        padding: 0 0 0 0;
        background-color: rgba(255,255,255,0.2);
      }
      paper-menu-button paper-button {
        margin: 0;
        text-transform: none;
        font-size: 16px;
        padding-left: 24px;
      }
    </style>
    <paper-icon-button icon="search" on-tap="revealSearch"></paper-icon-button>
    <div id="search" class="horizontal layout center">
      <paper-menu-button vertical-offset="48" hidden$="[[!ownership]]">
          <paper-button class="dropdown-trigger" slot="dropdown-trigger">Filters <iron-icon icon="icons:arrow-drop-down"></iron-icon></paper-button>
          <paper-listbox id="filterSelection" class="dropdown-content" slot="dropdown-content" attr-for-selected="value" selected="{{filter}}">
              <template is="dom-repeat" items="[[filters]]">
                  <paper-item value="[[item.filter]]" class$="hr-[[item.hr]]" on-tap="updateLocalStorage">
                    <span>[[item.name]]</span>
                    <paper-icon-button class="clear-filter" icon="icons:delete" title="Delete filter" on-tap="_deleteFilter" hidden$="[[item.default]]"></paper-icon-button>
                  </paper-item>
              </template>
          </paper-listbox>
      </paper-menu-button>
      <iron-icon icon="search"></iron-icon>
      <form on-submit="performSearch" class="flex-1">
          <input type="search" id="query" value="{{query::keyup}}" autocomplete="off" placeholder="Search">
      </form>
      <iron-icon icon="close" on-tap="clearSearch" hidden$="[[!showClear]]"></iron-icon>
      <paper-icon-button on-tap="_openDialogSaveFilter" icon="icons:save" hidden$="[[_hideSaveSearch(query, pageTitle, filters.length)]]" title="Save filter"></paper-icon-button>
    </div>
    <search-suggestions query="[[query]]" model="[[model]]" hide$="[[viewingList]]" width="[[width]]" visible="{{visibleSuggestions}}"></search-suggestions>
  </template>
  <script>
  Polymer({
    is: 'top-search',

    behaviors: [
      Polymer.IronResizableBehavior
    ],

    properties: {
      query: {
        type: String,
        notify: true,
        value: ""
      },
      pageTitle: {
        type: String,
        value: ''
      },
      model: {
        type: Object,
        notify: true
      },
      viewingList: Boolean,
      showClear: {
        type: Boolean,
        value: false
      },
      overflow: {
        type: Boolean,
        reflectToAttribute: true
      },
      width: {
        type: Number
      },
      filter: {
        type: String,
        value: ''
      },
      ownership: {
        type: Boolean,
        value: false
      },
      visibleSuggestions: {
        type: Boolean,
        notify: true
      },
      filters: {
        type: Array,
        value: []
      }
    },

    observers: [
      '_queryChanged(query)',
      'overflowChanged(overflow)',
      '_filterChanged(filter)',
      '_filtersChanged(filters.*)'
    ],

    listeners: {
      'keyup': 'hotkeys',
      'iron-resize': 'updateWidth'
    },

    attached: function() {
      var filter;
      try {
        filter = localStorage.getItem('mist-filter');
      } catch(e) {
        console.warn(e);
      }
      if (filter) {
          this.set('filter', filter);
      }
    },

    updateWidth: function() {
        this.debounce('windowResize', function() {
            this.set('width', this.getBoundingClientRect().width)
        }, 100);
    },

    performSearch: function(e) {
      e.preventDefault();
    },
    _filterChanged: function(filter) {
      this.debounce('updateLocalStorageFilter', this.updateLocalStorage, 500);
      if (filter.length){
        this.$.query.focus();
        this.set('showClear', true);
        if (this.query != filter)
          this.fire('search', filter);
      } else {
        this.clearSearch();
      }
      this.fire('search', filter);
    },
    updateLocalStorage: function(e) {
      try {
        if (typeof this.filter == 'string' && localStorage.getItem('mist-filter') != this.filter)
          localStorage.setItem('mist-filter', this.filter);
      } catch(e) {
        console.warn(e);
      }
    },
    _queryChanged: function(q) {
      if (q && q.length) {
        this.$.query.focus();
        this.set('showClear', true);
        this.updateLocalStorage();
      } else {
        this.set('showClear', this.overflow || false);
      }
      this.fire('search', this.query);
    },
    clearSearch: function(e){
      this.set('query',"");
      this.$.query.blur();
      if (this.overflow)
        this.set('overflow', false);
    },
    hotkeys: function(e) {
        // ESC
        if (e.keyCode === 27 && Polymer.dom(e).rootTarget === this.$.query) {
            this.set('query',"");
            if (this.overflow)
              this.set('overflow', false)
        }
        // ENTER
        // if (e.keyCode === 13 && Polymer.dom(e).rootTarget === this.$.query && this.query.length) {}
    },
    revealSearch: function(e) {
      this.set('overflow', true);
      this.set('showClear', true);
    },
    overflowChanged: function(overflow) {
      if (overflow){
        this.updateWidth();
        this.$.query.focus();
      } else
        this.$.query.blur();
      this.set('showClear', this.overflow);
    },
    _openDialogSaveFilter: function(e) {
      this.fire('open-save-filter-dialog', this.query);
    },
    _deleteFilter: function(e) {
      e.stopPropagation();
      this.fire('filter-delete', {filter: e.model.item});
    },
    _hideSaveSearch: function(querylength, title, presetFilters) {
      return !this.query || ['dashboard'].indexOf(this.pageTitle) > -1 || 
              this.filters.map(function(m){return m.filter;}).indexOf(this.query) > -1;
    },
    _filtersChanged: function(filters){
      if (this.filters.map(function(m){return m.filter;}).indexOf(this.query) > -1) {
        this.set('filter',this.query);
      }
    }
  });
  </script>
</dom-module>
