<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<dom-module id="mist-filters">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        height: inherit;
      }

      paper-icon-button {
        display: block;
        margin: 4px;
        float: right;
      }

      paper-icon-button.clear-filter {
        opacity: .5;
        transform: scale(.7);
        flex: none;
        margin-right: -10px;
        pointer-events: all !important;
      }

      paper-icon-button {
        align-self: center;
      }

      paper-menu-button {
        padding: 0;
        background-color: rgba(255,255,255,0.2);
      }

      paper-menu-button paper-button {
        margin: 0;
        font-size: 16px;
        padding-left: 24px;
      }

      paper-item span {
        flex: 1;
      }

      paper-item.hr-true:not(:last-of-type) {
        border-bottom: 1px solid #eee;
      }

    </style>

    <paper-menu-button vertical-offset="48">
      
      <slot name="dropdown-trigger"></slot>
      <content select="dropdown-trigger"></content>

      <paper-menu id="filterSelection" class="dropdown-content" slot="dropdown-content" attr-for-selected="value" selected="{{filter}}">
          <template is="dom-repeat" items="[[filters]]">
              <paper-item value="[[item.filter]]" class$="hr-[[item.hr]]" on-tap="updateLocalStorage">
                <span>[[item.name]]</span>
                <paper-icon-button class="clear-filter" icon="icons:delete" title="Delete filter" on-tap="_deleteFilter" hidden$="[[item.default]]"></paper-icon-button>
              </paper-item>
          </template>
      </paper-menu>
    </paper-menu-button>

    <slot name="searchFields"></slot>
    <content select="searchFields"></content>

    <paper-icon-button on-tap="_openDialogSaveFilter" icon="icons:save" hidden$="[[hideSaveButton]]" title="Save filter" class="saveFilter" slot="saveFilter"></paper-icon-button>

  </template>
  <script>
  Polymer({
    is: 'mist-filters',
    properties: {
      query: {
        type: String,
        notify: true,
        value: ""
      },
      filters: {
        type: Array,
        value: []
      },
      filter: {
        type: String,
        value: ''
      },
      hideSaveButton: {
        type: Boolean,
        value: false
      }
    },

    observers: [
      '_filterChanged(filter)',
      '_filtersChanged(filters.*)'
    ],

    attached: function() {
      var filter;
      try {
        filter = localStorage.getItem('mist-filter');
      } catch(e) {
        console.warn(e);
      }
      if (filter) {
          this.set('filter', filter);
      }
    },

    _filtersChanged: function(filters){
      if (this.filters.map(function(m){return m.filter;}).indexOf(this.query) > -1) {
        this.set('filter',this.query);
      }
    },

    _filterChanged: function(filter) {
      this.debounce('updateLocalStorageFilter', this.updateLocalStorage, 500);
      if (filter.length){
        // this.$.query.focus();
        this.set('showClear', true);
        if (this.query != filter)
          this.fire('search', filter);
      } 
      // else {
      //   this.clearSearch();
      // }
      this.fire('search', filter);
    },

    updateLocalStorage: function(e) {
      try {
        if (typeof this.filter == 'string' && localStorage.getItem('mist-filter') != this.filter)
          localStorage.setItem('mist-filter', this.filter);
      } catch(e) {
        console.warn(e);
      }
    },

    _openDialogSaveFilter: function(e) {
      this.fire('open-save-filter-dialog', this.query);
    },

    _saveFilter: function(e) {
        if (["", "dashboard"].indexOf(this.page) == -1 && this.querySelector('page-'+this.page+' mist-list')) {
            this.querySelector('page-'+this.page+' mist-list')._openDialogSaveFilter();
        }
    },

    _deleteFilter: function(e) {
        e.stopImmediatePropagation();
        console.log('delete',e.model.item);
        this.fire('filter-delete', {filter: e.model.item});

        var deleteFilter = e.model.item,
            index = this.filters.findIndex(function(f){
              console.log('filter', f.filter == deleteFilter.filter && f.name == deleteFilter.name && f.default == deleteFilter.default)
                return f.filter == deleteFilter.filter && f.name == deleteFilter.name && f.default == deleteFilter.default});
        if (index > -1) {
            this.splice('filters',index,1);
        }
        if (this.q == deleteFilter.filter) {
            this.fire('search', '');
        }
    },

  });
  </script>
</dom-module>