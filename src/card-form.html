<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/gold-cc-input/gold-cc-input.html">
<link rel="import" href="../bower_components/gold-cc-cvc-input/gold-cc-cvc-input.html">

<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<dom-module id="card-form">
    <template>
        <style include="shared-styles forms">
            #form {
                width: 360px;
                font-size: inherit;
            }
            .logo {
                position: absolute;
                top: -64px;
                left: calc(50% - 64px);
            }
            .head {
                padding-top: 32px;
                text-align: center;
            }
            .form-inputs {
                padding: 8px;
                width: 100%;
                margin-bottom: 16px;
                box-sizing: border-box;
                background-color: #fafafa;
                border: 1px solid #eee;
            }
            .form-row {
                padding: 4px 0;
                font-size: inherit;
            }
            .align {
                align-items: center;
                justify-content: space-between;
                @apply(--layout-horizontal);
            }
            label {
                font-size: 16px;
                color: #0099cc !important;
                text-transform: uppercase;
                transform: scale(0.75);
                text-indent: -20px;
                display: block;
            }
            gold-cc-cvc-input {
                padding-bottom: 8px;
            }
            .expiration {
                position: relative;
            }
            #expirationMonth, #expirationYear, span {
                display: inline-block;
            }
            #expirationMonth, #expirationYear {
                width: 40px;
                text-align: center;
            }
            #zipCode {
                display: inline-block;
                width: 50%;
            }
            #zipCode::content label {
                top: -9px;
            }
        </style>
        <div class="form-inputs" hidden$="[[hideCardFields]]">

            <gold-cc-input card-type="{{cardType}}" data-stripe="number" value="{{payload.number::input}}" auto-validate always-float-label></gold-cc-input>
            <gold-cc-cvc-input card-type="[[cardType]]" label="Card Verification Value" value="{{payload.cvc::input}}" auto-validate always-float-label></gold-cc-cvc-input>

            <div class="align">
                <div class="expiration">
                    <label>Expiration Date</label>
                    <paper-input id="expirationMonth" type="text" data-stripe="exp_month" value="{{payload.exp_month::input}}" placeholder="MM" no-label-float></paper-input>
                    <span>/</span>
                    <paper-input id="expirationYear" type="text" data-stripe="exp_year" value="{{payload.exp_year::input}}" placeholder="YY" no-label-float></paper-input>
                </div>
            
                <paper-input id="zipCode" label="Zip Code" type="text" pattern="[0-9]*" data-stripe="address_zip" value="{{payload.address_zip::input}}" always-float-label></paper-input>
            </div>

        </div>
    </template>
    <script>
        Polymer({
            is: 'card-form',

            properties: {
                isOverUsing: Boolean,
                user: Object,
                org: Object,
                plan: Object,
                payload: {
                    type: Object,
                    value: function(){
                        return {
                            number: "",
                            exp_month: "",
                            exp_year: "",
                            cvc: "",
                            address_zip: ""
                        }
                    },
                    notify: true
                },
                addCard: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },
                sendingData: {
                    type: Boolean,
                    value: false
                },
                formError: {
                    type: Boolean,
                    value: false
                },
                cardValid: {
                    type: Boolean,
                    value: false
                },
                hasCard: {
                    type: Boolean,
                    value: false
                },

            },
            keyBindings: {
              '/': '_selectYear'
            },
            observers: [
              '_computeDate(month, year)'
            ],
            ready: function(){

            },
            verify: function(){
                //extra stripe validation
                var isValid = Stripe.card.validateCardNumber(this.payload.number) &&
                    Stripe.card.validateExpiry(this.payload.exp_month, this.payload.exp_year) &&
                    Stripe.card.validateCVC(this.payload.cvc) && this.payload.address_zip != '';

                if (isValid){
                    Stripe.setPublishableKey(STRIPE_PUBLIC_APIKEY);
                    Stripe.card.createToken(this.payload, stripeResponseHandler);
                    this.set('sendingData', true);
                    var that = this;
                    function stripeResponseHandler(status, response){
                        if (response.error) {
                            console.log('stripeResponseHandler failed', response.error.message);
                            that.showError(response.error.message);
                        }
                        else {
                            that.sumbmitPayment(status, response);
                        }
                    }
                }
                else {
                    var errorText = 'There seems to be an error in';
                    if (!Stripe.card.validateCardNumber(this.payload.number))
                        errorText += ' card number';

                    if (!Stripe.card.validateExpiry(this.payload.exp_month, this.payload.exp_year))
                        errorText += ' expiration';

                    if (!Stripe.card.validateCVC(this.payload.cvc))
                        errorText += ' cvc';

                    if (this.payload.address_zip == '')
                        errorText += ' zip code';

                    errorText += '.';

                    this.showError(errorText);
                }
            },
            validateForm: function(error){
                this.set('isValid', false);
                this.$.errormsg.textContent = '';

                if (this.valideNumber('Card-number',this.payload.number,0) && this.valideNumber('Expiration month',this.payload.exp_month,2) && this.valideNumber('Expiration year',this.payload.exp_year,2) && this.valideNumber('CVC',this.payload.cvc,3))
                    this.set('isValid', true);

                else
                    this.set('isValid', false);
            },
            valideNumber: function(name, input, length){
                if (!input || !input.length){
                    //no input
                    return false;
                }
                if (length !=0 && input.length > length){
                    //input longer than constrain
                    this.showHelp(name, length);
                    return false;
                }
                if (!(/^[0-9 ]*$/.test(input))){
                    //input is not number
                    this.showHelp(name);
                    return false;
                }
                return true;
            },
            _selectYear: function() {
              this.$.expirationYear.focus();
            },
            _computeDate: function(month, year) {
              // Months are 0-11.
              this.date = {month: month, year: year};
              this.fire('dateChanged', this.date);
              // Advance cursor to year after month entry
              if (month && month.length === 2) {
                this._selectYear();
              }
            },
        });
    </script>
</dom-module>