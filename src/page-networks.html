<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/mist-list/mist-list.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="networks/network-create.html">
<link rel="import" href="networks/network-page.html">
<link rel="import" href="networks/network-actions.html">

<link rel="import" href="helpers/mist-lists-behavior.html">
<link rel="import" href="helpers/owner-filter-behavior.html">
<link rel="import" href="mist-actions.html">

<dom-module id="page-networks">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>

        <app-route route="{{route}}" pattern="/:network" data="{{data}}"></app-route>

        <template is="dom-if" if="[[_isListActive(route.path)]]" restamp>
            <mist-list id="networksList" selectable resizable column-menu multi-sort apiurl="/api/v1/networks" item-map="[[model.networks]]"
                name="Networks" selected-items="{{selectedItems}}" filtered-items-length="{{filteredItemsLength}}" combined-filter={{combinedFilter}}
                frozen=[[_getFrozenLogColumn()]] visible=[[_getVisibleColumns()]] renderers=[[_getRenderers()]]
                route={{route}} user-filter=[[model.sections.networks.q]] primary-field-name="id" filter-method="[[_ownerFilter()]]">
                <mist-actions slot="action-buttons" actions="[[actions]]" type="network" items="[[selectedItems]]" model="[[model]]"></mist-actions>
                <network-actions slot="actions" items="[[selectedItems]]" actions="{{actions}}" user="[[model.user.id]]" members="[[model.membersArray]]" org="[[model.org]]"></network-actions>
                <p slot="no-items-found">No networks found.</p>
            </mist-list>
            <div class="absolute-bottom-right">
                <paper-fab id="networkAdd" icon="add" on-tap="_addResource"></paper-fab>
            </div>
        </template>
        <network-create model="[[model]]" section="[[model.sections.networks]]" hidden$=[[!_isAddPageActive(route.path)]]></network-create>
        <network-page model="[[model]]" network="[[_getNetwork(data.network, model.networks)]]" resource-id="[[data.network]]" section="[[model.sections.networks]]"
            hidden$=[[!_isDetailsPageActive(route.path)]]></network-page>
    </template>

    <script>
        Polymer({
            is: 'page-networks',
            behaviors: [
                mistListsBehavior,
                ownerFilterBehavior
            ],

            properties: {
                model: Object,
                actions: {
                    type: Array,
                    notify: true
                },
                selectedItems: {
                    type: Array,
                    notify: true
                }
            },
            
            listeners: {
                'select-action': 'selectAction',
            },
            
            _isAddPageActive: function (path) {
                return path == '/+add';
            },
            
            _isDetailsPageActive: function (path) {
                if (path && path != '/+add' && this.querySelector('network-page'))
                    this.querySelector('network-page').updateState();
                return path && path != '/+add';
            },
            
            _isListActive: function (path) {
                return !path;
            },
            
            _getNetwork: function (id) {
                if (this.model.networks)
                    return this.model.networks[id];
            },
            
            _addResource: function (e) {
                this.fire('go-to', {
                    url: this.model.sections.networks.add
                });
            },
            
            _getFrozenLogColumn: function () {
                return ['name'];
            },

            _getVisibleColumns: function () {
                var ret = ['provider', 'created_by', 'subnets', 'state', 'tags'];
                if (this.model.org && this.model.org.ownership_enabled == true)
                    ret.splice(ret.indexOf('created_by'), 0, 'owned_by');
                return ret;
            },

            _getRenderers: function (networks, clouds) {
                var _this = this;
                return {
                    'name': {
                        'body': function (item, row) {
                            return '<strong class="name">' + item + '</strong>';
                        }
                    },
                    'provider': {
                        'title': 'cloud',
                        'body': function (item, row) {
                            return _this.model && _this.model.clouds && _this.model.clouds[row.cloud] ?
                                _this.model.clouds[row.cloud].title : item;
                        }
                    },
                    'owned_by': {
                        'title': 'owner',
                        'body': function (item, row) {
                            return _this.model.members[item] ? _this.model.members[item].name || _this.model.members[item].email : '';
                        }
                    },
                    'created_by': {
                        'title': 'created by',
                        'body': function (item, row) {
                            return _this.model.members[item] ? _this.model.members[item].name || _this.model.members[item].email : '';
                        }
                    },
                    'subnets': {
                        'body': function (item, row) {
                            return item && Object.keys(item) ? Object.keys(item).length : '';
                        }
                    },
                    'state': {
                        'body': function (item, row) {
                            var provider = _this.model.clouds[row.cloud].provider;
                            if (provider == 'ec2')
                                return row.extra && row.extra.state != undefined ? row.extra.state : '';
                            else if (provider == 'openstack')
                                return row.admin_state_up != undefined ? 'admin state up:' + row.admin_state_up :
                                    '';
                            else
                                return '';
                        }
                    },
                    'tags': {
                        'body': function (item, row) {
                            var tags = item,
                                display = "";
                            for (key in tags) {
                                display += "<span class='tag'>" + key;
                                if (tags[key] != undefined && tags[key] != "")
                                    display += "=" + tags[key];
                                display += "</span>";
                            }
                            return display;
                        }
                    }
                }
            },
            // redirect events
            selectAction: function (e) {
                e.stopImmediatePropagation();
                if (this.querySelector('network-actions')) {
                    this.querySelector('network-actions').selectAction(e);
                }
            }

        });
    </script>
</dom-module>