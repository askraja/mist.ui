<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../bower_components/paper-time-picker/paper-time-picker.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/mist-list/mist-list.html">

<link rel="import" href="../helpers/dialog-element.html">
<link rel="import" href="../mist-actions.html">
<link rel="import" href="../machines/machine-actions.html">
<link rel="import" href="../helpers/machines-list-behavior.html">

<link rel="import" href="schedule-edit.html">
<link rel="import" href="schedule-edit-mrc.html">
<link rel="import" href="schedule-edit-condition.html">
<link rel="import" href="schedule-edit-task.html">

<dom-module id="schedule-page">
    <template>
        <style include="shared-styles single-page tags-and-labels forms">
            :host {
                display: block;
            }

            paper-material {
                display: block;
                padding: 20px;
            }

            paper-menu-button paper-button {
                display: block;
            }

            .flex-horizontal-with-ratios {
                @apply(--layout-horizontal);
            }

            .flexchild {
                @apply(--layout-flex);
            }

            .command-container {
                background-color: #444;
                color: #fff;
                font-family: monospace;
                padding: 10px;
            }

            a {
                color: black;
                text-decoration: none;
            }

            .paper-header [paper-drawer-toggle] {
                margin-left: 10px;
            }

            .paper-header {
                @apply(--layout-horizontal);
            }

            .paper-header {
                height: 60px;
                font-size: 24px;
                line-height: 60px;
                padding: 0 10px;
                color: white;
                transition: height 0.2s;
                transition: font-size 0.2s;
            }

            .paper-header.tall {
                height: 320px;
                font-size: 16px;
            }

            .paper-header h2 {
                margin-left: 20px;
                @apply(--layout-flex);
                text-transform: capitalize;
            }

            .paper-header .toggleViewButton {
                --paper-icon-button-ink-color: transparent;
            }

            .paper-header .cartButton {
                margin-right: 10px;
            }

            #content {
                -webkit-overflow-scrolling: touch;
            }

            paper-icon-button {
                transition: all 200ms;
            }

            paper-icon-button.active-sort {
                transform: rotate(180deg);
            }

            paper-icon-button.active-sort::content iron-icon {
                color: #D48900 !important;
            }
            h4.id {
                display: inline-block;
            }
            h4 {
                text-transform: uppercase;
                font-size: 0.9rem;
                font-weight: 700;
                margin-right: 16px;
            }

            .conditions {
                line-height: 1.85em;
                padding-bottom: 8px;
            }

            paper-icon-bottom.bottom {
                padding-right: 8px;
            }
            .m-info-head {
                text-transform: uppercase;
                font-weight: bold;
                font-size: 0.8em;
                display: inline-block;
                width: 80px;
                opacity: 0.54;
            }
            .does-not-exist {
                text-align: center;
                min-height: 500px;
            }
            .smaller {
                font-size: 0.9em
            }
            .smaller .tag {
                display: inline;
                vertical-align: middle;
                padding: 2px 0.5em !important;
            }
            paper-button.blue-link[disabled] {
                color: rgba(0,0,0,0.32) !important;
            }
            paper-button.blue-link {
                background-color: transparent !important;
                font-weight: 400 !important;
                color: var(--mist-blue) !important;
                margin: 0;
                padding: 0;
            }
            :host paper-toggle-button {
                display: inline-block;
                vertical-align: top;
                --paper-toggle-button-checked-bar-color:  var(--green-color);
                --paper-toggle-button-checked-button-color:  var(--green-color);
                --paper-toggle-button-checked-ink-color: var(--green-color);
                --paper-toggle-button-unchecked-bar-color:  var(--red-color);
                --paper-toggle-button-unchecked-button-color:  var(--red-color);
                --paper-toggle-button-unchecked-ink-color: var(--red-color);
            }
            #dateTimePickers .bottom-actions {
                display: flex;
                justify-content: flex-end;
                padding: 16px 24px !important;
                background-color: #424242;
                color: rgba(255,255,255,0.54);
                border-top: 1px solid #555;
            }
            paper-date-picker::content #heading,
            paper-time-picker::content #heading {
                background-color: #424242;
            }
            paper-date-picker ::content .day-item.selected.paper-calendar {
                background: var(--mist-blue) !important;
            }
            paper-time-picker ::content .line.paper-clock-selector {
                stroke: var(--mist-blue) !important;
            }
            paper-time-picker ::content .disc-large.paper-clock-selector {
                fill: var(--mist-blue) !important;
            }
            paper-dialog > * {
                margin: 0 !important;
                padding: 0 !important;
            }
            .never-expire {
                background-color: #424242;
                padding: 16px;
            }
            .never-expire paper-checkbox {
                color: #fff;
                font-weight: 500;
                font-size: 16px;
                text-transform: uppercase;
            }
            paper-checkbox {
                --paper-checkbox-unchecked-color: #fff !important;
                --paper-checkbox-unchecked-ink-color: #fff !important;
                --paper-checkbox-label-color: #fff !important;
                --paper-checkbox-checked-color: var(--mist-blue) !important;
                --paper-checkbox-checked-ink-color: var(--mist-blue) !important;
            }
            .progress {
                background-color: #424242;
                overflow: hidden;
            }
            paper-progress {
                width: 100%;
            }
            paper-progress#progresserror ::content #primaryProgress {
                background-color: var(--red-color);
            }
            .errormsg-container {
                color: rgba(255,255,255,0.54);
            }
            .errormsg-container iron-icon {
                color: var(--red-color);
                margin: 8px;
            }
            .note {
                color: rgba(0,0,0,0.32);
                font-size: 0.9em;
            }
            .counts {
                padding: 0 8px;
                text-align: center;
            }
            .counts h2 {
                font-size: 26px;
                margin: 0;
                padding: 0;
            }
            .counts .m-info-head {
                width: 120px;
            }
            .missing-machines {
                margin-bottom: 16px;
            }
            .machine {
                line-height: 2em;
            }
            .machine code {
                background-color: #eee;
                padding: 2px 4px;
                border-radius: 4px;
            }
        </style>
        <div id="content" hidden$="[[!exists]]">
            <paper-material class="single-head layout horizontal" style$="color:#fff;background-color: [[section.color]];">
                <span class="icon"><iron-icon icon="[[section.icon]]"></iron-icon></span>
                <div class="title flex">
                    <h2>[[schedule.name]]</h2>
                    <div class="subtitle">
                        [[_makeCleanerTask(schedule.task_type)]], [[_parseToLocalTime(schedule.schedule)]]
                        <span hidden$="[[!isCrontab]]">UTC time</span>
                    </div>
                </div>
                <div class="item-actions">
                    <paper-button on-tap="_runOnceDialog" class="simple" hidden$="[[_hideRunNow(hasExpired, schedule.max_run_count, schedule.total_run_count)]]">run now
                        <iron-icon icon="av:play-arrow"></iron-icon>
                    </paper-button>
                    <paper-button on-tap="_editSchedule" class="simple" hidden$="[[hasExpired]]">edit
                        <iron-icon icon="editor:mode-edit"></iron-icon>
                    </paper-button>
                    <paper-button on-tap="_deleteSchedule" class="simple">delete
                        <iron-icon icon="delete"></iron-icon>
                    </paper-button>
                </div>
            </paper-material>
            <paper-material>
                <div class="layout horizontal">
                    <div class="flex">
                        <h4 class="id">
                            <paper-toggle-button id="scheduleEnabled" checked="[[schedule.task_enabled]]" on-tap="toggleEnable" disabled$="[[hasExpired]]"></paper-toggle-button>
                            <span hidden$="[[hasExpired]]">
                                <span hidden$="[[!schedule.task_enabled]]">Enabled</span>
                                <span hidden$="[[schedule.task_enabled]]">Disabled</span>
                            </span>
                            <span hidden$="[[!hasExpired]]">Scheduler has expired.</span>
                        </h4>
                        <span hidden$="[[hasExpired]]">
                            <span class="note" hidden$="[[!schedule.active]]">Currently active.</span>
                            <span class="note" hidden$="[[schedule.active]]">Currently not active.</span>
                        </span>
                    </div>
                    <div class="counts">
                        <h2>[[schedule.total_run_count]]</h2>
                        <div class="m-info-head">Run Count</div>
                    </div>
                    <div class="counts">
                        <h2>[[schedule.max_run_count]]
                            <paper-icon-button on-tap="_editMaxRunCount" icon="editor:mode-edit" disabled$="[[isOneOff]]" hidden$="[[isOneOff]]" disabled$="[[hasExpired]]"></paper-icon-button>
                        </h2>
                        <div class="m-info-head">
                            <div class="layout horizontal">
                                <span>Maximum Runs</span>
                            </div>
                        </div> 
                    </div>
                </div>
            </paper-material>
            <paper-material>
                <div hidden$="[[!schedule.description]]"><span class="m-info-head">Descr.:</span> [[schedule.description]]</div>
                <div><span class="m-info-head">ID:</span> [[schedule.id]]</div>
                <div>
                    <span class="m-info-head">Starts:</span>
                    <span hidden$="[[!schedule.start_after]]">[[_computeAbsoluteDateText(schedule.start_after)]]</span>
                    <span hidden$="[[schedule.start_after.length]]">Now</span>
                    <paper-button id="editStart" on-tap="_selectDate" data-field="start_after" class="simple-button blue-link smaller" noink disabled$=f"[[hasExpired]]">change</paper-button>
                </div>
                <div><span class="m-info-head">Expires:</span>
                    <span hidden$="[[schedule.expires.length]]">Never</span>
                    <span hidden$="[[!schedule.expires]]">[[_computeAbsoluteDateText(schedule.expires)]]</span>
                    <paper-button id="editExpiration" on-tap="_selectDate" data-field="expires" class="simple-button blue-link smaller" noink>change</paper-button>
                </div>
                <div hidden$="[[!schedule.last_run_at]]"><span class="m-info-head">Last Run:</span> [[_computeAbsoluteDateText(schedule.last_run_at)]] ([[_computeDateFromNow(schedule.last_run_at)]])</div>
                <div>
                    <span class="m-info-head">Schedule:</span> [[_makeCleanerTask(schedule.task_type)]], [[_parseToLocalTime(schedule.schedule)]]
                    <span hidden$="[[!isCrontab]]">UTC time</span>
                    <a href$="[[_computeScriptLink(schedule)]]" class="blue-link regular smaller" hidden$="[[!isRunScript]]"> <iron-icon icon="link"></iron-icon>view script</a>
                    <paper-button id="editTask" on-tap="_editTask" class="simple-button blue-link smaller" noink disabled$="[[hasExpired]]">change</paper-button>
                </div>
            </paper-material>
            <paper-material>
                <h4>Machines</h4>
                <div class="conditions">
                    <span hidden$="[[!isSpecificMachines]]" class="smaller"> [[machinesIds.length]] selected machine(s) </span>
                    <span hidden$="[[!isMachinesWithTags]]" class="smaller">
                        Machines with tags
                        <template is="dom-repeat" items="[[tagsArray]]">
                            <span class="tag">[[item]]</span>
                        </template>
                        &nbsp; [[filteredItems.length]] machines affected </span>
                    <span class="smaller" hidden$="[[!machineAge]]">when OLDER THAN [[_computeAgeText(machineAge)]]</span>
                    <span class="smaller" hidden$="[[!machineCost]]">and if MACHINE COST is more than $[[machineCost]]/month</span>
                    <paper-button id="editCondition" on-tap="_changeCondition" class="simple-button blue-link smaller" noink disabled$="[[hasExpired]]">change</paper-button>
                </div>
                <div class='missing-machines'>
                    <template is="dom-repeat" items="[[missingMachines]]">
                        <div class="machine">1 Missing machine with id <code>[[item]]</code></div>
                    </template>
                </div>

                <mist-list id="machinesList"
                    selectable column-menu multi-sort
                    items="[[filteredItems]]"
                    name="Machines"
                    selected-items="{{selectedItems}}"
                    filtered-items-length="{{filteredItemsLength}}"
                    frozen=[[_getFrozenLogColumn()]]
                    visible=[[_getVisibleColumns()]]
                    renderers=[[_getRenderers(model.machinesArray.*,model.cloudsArray.*,model.incidentsArray.*)]]
                    route={{route}}
                    primary-field-name="id" hidden$="[[!filteredItems]]">
                    <mist-actions slot="action-buttons" actions="{{actions}}" type="machine" items="[[selectedItems]]" model="[[model]]"></mist-actions>
                    <machine-actions slot="actions" actions="{{actions}}" items="[[selectedItems]]" model="[[model]]"></machine-actions>
                    <p slot="no-items-found">No machines found.</p>
              </mist-list>

            </paper-material>
        </div>
        <dialog-element id="scheduleModal" entry-animation="scale-up-animation" exit-animation="fade-out-animation"></dialog-element>
        <paper-dialog id="dateTimePickers" exit-animation="fade-out-animation" with-backdrop>
            <div class="pickers">
                <paper-date-picker id="pickDate" class="date-button"></paper-date-picker>
                <paper-time-picker id="pickTime" class="time-button"></paper-time-picker>
                <div class="never-expire">
                    <paper-checkbox checked="{{neverExpire}}">Clear</paper-checkbox>
                </div>
            </div>
            <div class="progress">
                <paper-progress id="progress" indeterminate active="{{expLoading}}" hidden$="[[!expLoading]]"></paper-progress>
                <paper-progress id="progresserror" value="100" hidden$="[[!expError]]"></paper-progress>
                <p class="errormsg-container" hidden$="[[!expError]]"><iron-icon icon="icons:error-outline"></iron-icon><span id="errormsg"></span></p>
            </div>
            <div class="bottom-actions">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button id="dateTimePickersApplyButton" class="blue" on-tap="_applyDateTime">Apply</paper-button>
            </div>
        </paper-dialog>

        <schedule-edit id="editScheduleDialog" schedule="[[schedule]]" model="[[model]]"></schedule-edit>
        <schedule-edit-mrc id="editMaxRunCount" schedule="[[schedule]]"></schedule-edit-mrc>
        <schedule-edit-task id="editScheduleTask" schedule="[[schedule]]" scripts="[[model.scriptsArray]]"></schedule-edit-task>
        <schedule-edit-condition id="editScheduleCondition" 
            schedule="[[schedule]]" 
            model="[[model]]" 
            machines-age="[[machineAge]]"
            machines-cost="[[machineCost]]"></schedule-edit-condition>

        <iron-ajax  id="deleteSchedule"
                    url="/api/v1/schedules/[[schedule.id]]"
                    method="DELETE"
                    on-response="_handleScheduleDeleteResponse"
                    on-error="_handleScheduleDeleteError"></iron-ajax>

        <iron-ajax  id="editToggleSchedule"
                    url="/api/v1/schedules/[[schedule.id]]"
                    method="PATCH"
                    loading="{{toogleLoading}}"
                    handle-as="xml"
                    on-response="_handleScheduleEditToggleResponse"
                    on-error="_handleScheduleEditToggleError"></iron-ajax>

        <iron-ajax  id="editExpirationSchedule"
                    url="/api/v1/schedules/[[schedule.id]]"
                    method="PATCH"
                    loading="{{expLoading}}"
                    handle-as="xml"
                    on-response="_handleScheduleEditExpirationResponse"
                    on-error="_handleScheduleEditExpirationError"></iron-ajax>

    </template>
    <script>
        Polymer({
            is: 'schedule-page',
            behaviors: [
                machinesListBehavior
            ],

            properties: {
                model: Object,
                sections: Array,
                section: Object,
                schedule: Object,
                toogleLoading: Boolean,
                isLoading: {
                    type: Boolean,
                    value: true
                },
                exists: {
                    type: Boolean,
                    value: false
                },
                filteredItems: {
                    type: Array
                },
                missingMachines: {
                    type: Array
                },
                sortBy: {
                    type: String,
                    value: "name"
                },
                sortOrder: {
                    type: Number,
                    value: 1
                },
                conditions: {
                    type: Array,
                    value: []
                },
                machinesIds: {
                    type: Array,
                    computed: "_computeMachinesIds(conditions)"
                },
                hasExpired: {
                    type: Boolean,
                    value: false,
                    computed: "_computeHasExpired(schedule.*)"
                },
                isSpecificMachines: {
                    type: Boolean,
                    computed: "_computeIsSpecificMachines(schedule.conditions)"
                },
                isMachinesWithTags: {
                    type: Boolean,
                    computed: "_computeIsMachinesWithTags(schedule.conditions)"
                },
                isInterval:  {
                    type: Boolean,
                    computed: "_computeIsInterval(schedule.type)"
                },
                isCrontab:  {
                    type: Boolean,
                    computed: "_computeIsCrontab(schedule.type)"
                },
                isOneOff:  {
                    type: Boolean,
                    computed: "_computeIsOneOff(schedule.type)"
                },
                isAction:  {
                    type: Boolean,
                    computed: "_computeIsAction(schedule)"
                },
                isRunScript:  {
                    type: Boolean,
                    computed: "_computeIsRunScript(schedule)"
                },
                expLoading: {
                    type: Boolean,
                    value: false
                },
                tagsArray: {
                    type: Array,
                    computed: '_computeTagsArray(schedule, isMachinesWithTags)'
                },
                neverExpire: Boolean,
                expError: Boolean,
                machines: Array,
                tags: Array,
                lastrequestedaction: String,
                machineAge: {
                    type: Number,
                    value: false,
                    computed: '_computeMachineAge(schedule.conditions)'
                },
                machineCost: {
                    type: Number,
                    value: false,
                    computed: '_computeMachineCost(schedule.conditions)'
                },
                selectedItems: Array,
                actions: Array
            },
            observers: [
                '_scheduleChanged(schedule)',
                '_computeMachines(schedule.*, model.machinesArray)'
            ],
            listeners: {
                'confirmation': '_actionConfirmed',
            },
            attached: function() {
                this.isLoading = false;
                this.$.pickDate.minDate = moment().add(-1, 'days').toDate();
            },
            _scheduleChanged: function(schedule) {
                if (this.schedule && this.schedule.id) {
                    this.exists = true;
                    this.set('conditions', this.schedule.conditions)
                }
                else {
                    this.exists = false;
                }
            },
            _computeHasExpired: function(schedule) {
                if (this.schedule && this.schedule.expires != undefined && this.schedule.expires != "" && this.schedule.expires.length > 0){
                    return moment().diff(moment.utc(this.schedule.expires).local()) > 0;
                }
                else {
                    return false;
                }
            },
            _computeIsInterval: function(schedule) {
                if (this.schedule)
                    return this.schedule.schedule_type == "interval";
            },
            _computeIsCrontab: function(schedule) {
                if (this.schedule)
                    return this.schedule.schedule_type == "crontab";
            },
            _computeIsOneOff: function(schedule) {
                console.log('_computeIsOneOff');
                if (this.schedule)
                    return this.schedule.schedule_type == "one_off";
            },
            _computeIsAction: function(schedule) {
                if (this.schedule)
                    return this.schedule.task_type.startsWith("Action:");
            },
            _computeIsRunScript: function(schedule) {
                if (this.schedule)
                    return this.schedule.task_type.startsWith("Run script:");
            },
            _computeIsSpecificMachines: function(schedule) {
                if (this.schedule)
                    return this.schedule.conditions && this.schedule.conditions.length > 0 && this._findCondition('machines') ? true : false;
            },
            _computeIsMachinesWithTags: function(schedule) {
                if (this.schedule)
                    return this.schedule.conditions && this.schedule.conditions.length > 0 && this._findCondition('tags')  ? true : false;
            },
            _findCondition: function(field) {
                if (this.schedule.conditions && this.schedule.conditions.length){
                    var field = this.schedule.conditions.find(function(con){
                        return ['age', 'machines', 'tags'].indexOf(field) == -1 ? con.field == field : con.type == field;
                    })
                    if (field)
                        return true;
                    return false;
                }
                return false;
            },
            _computeMachineAge: function(conditions){
                if (conditions){
                    var ageEntry = conditions.find(function(c){
                        return c.type == 'age';
                    });
                    return ageEntry ? ageEntry.minutes || false : false;
                }
            },
            _computeMachineCost: function(conditions){
                if (conditions){
                    var costEntry = conditions.find(function(c){
                        return c.type == 'field' && c.field == 'cost__monthly';
                    });
                    return costEntry ? costEntry.value || false : false;
                }
            },
            _computeAgeText: function(age){
                var duration = 'minutes';
                var machineAge = parseInt(age);
                if (age >= 60 && age%(60) == 0) {
                    machineAge = age/60;
                    duration = 'hours';
                    if (machineAge == 1)
                        duration = 'hour';
                }
                if (age >= (60*24) && age%(60*24) == 0 ){
                    machineAge = age/(60*24);
                    duration = 'days';
                    if (machineAge == 1)
                        duration = 'day';
                }
                return machineAge +" "+ duration;
            },
            _editSchedule: function(e) {
                this.$.editScheduleDialog._openEditScheduleModal();
            },
            _deleteSchedule: function(e) {
                this._showDialog({
                    title: 'Delete Schedule?',
                    body: "Deleting schedules cannot be undone." ,
                    danger: true,
                    action: "delete",
                    reason: "schedule.delete"
                });
            },
            _actionConfirmed: function(e) {
                var reason = e.detail.reason,
                    response = e.detail.response;

                if (response.confirmed && reason == "schedule.delete") {
                    this.$.deleteSchedule.headers["Content-Type"] = 'application/json';
                    this.$.deleteSchedule.headers["Csrf-Token"] = CSRF_TOKEN;
                    this.$.deleteSchedule.generateRequest();
                }

                if (response.confirmed && reason == "schedule.run") {
                    this.$.editToggleSchedule.body = {'run_immediately': true}
                    this.$.editToggleSchedule.headers["Content-Type"] = 'application/json';
                    this.$.editToggleSchedule.headers["Csrf-Token"] = CSRF_TOKEN;
                    this.$.editToggleSchedule.generateRequest();
                    this.lastrequestedaction = 'run';
                }
            },
            _handleScheduleDeleteResponse: function(e) {
                this.fire('go-to', {url: '/schedules'});
            },
            _handleScheduleDeleteError: function(e) {
                var message = e.detail.error;
                if (e.detail.request.statusText)
                    message += " "+e.detail.request.statusText;

                this.fire('toast', { msg: message, duration: 5000 });
            },
            _showDialog: function(info) {
                var dialog = this.querySelector('dialog-element#scheduleModal');
                for (var i in info) {
                    dialog[i] = info[i];
                }
                dialog._openDialog();
            },
            _makeCleanerTask: function(str) {
                if (str) {
                    var ret = str.replace(" script:", "").replace("Action:", "");

                    if (this.isAction) {
                        ret = ret.toUpperCase();
                        ret += " machines";
                    }
                    else if (this.isRunScript) {
                        var script = str.split(": ")[1],
                            scriptName = this.model.scripts[script] ? this.model.scripts[script].name : "Missing Script";

                        ret = ret.replace(script, "");
                        ret += scriptName;
                    }
                    return ret;
                }
            },
            _parseToLocalTime: function(string) {
                if (!this.isOneOff) 
                    return string;
                else {
                    if (string){
                        var newString = "once on " + moment.utc(this.schedule.schedule_entry.entry).local().format('YYYY-MM-DD HH:mm').toString() +" ("+ moment.utc(this.schedule.schedule_entry.entry).local().fromNow()+")";
                    }
                    return newString;
                }
            },
            _computeScriptLink: function(schedule) {
                if (this.schedule && this.schedule.task_type.startsWith("Run script:")) {
                    return '/scripts/'+this.schedule.task_type.split(": ")[1]
                }
            },
            _computeMachines: function(schedule, machines) {
                var filteredMachines = [],
                    missingMachines = [];
                filteredMachines = this.model.machinesArray.filter(function(m){
                    return this.condition(m);
                }, this);

                if (this.schedule.conditions && this._findCondition('machines')) {
                    for (var i = 0; i < this.machinesIds.length; i++) {
                        var machine = this.schedule.conditions.find(function(c){return c.type == "machines"}).ids[i];
                        if (this.model.machines && !this.model.machines[machine]){
                            missingMachines.push(machine);
                        }
                    }
                }

                this.set('filteredItems', filteredMachines);
                this.set('missingMachines', missingMachines);
            },
            _computeMachinesIds: function(conditions) {
                var ids = [];
                if (!this.conditions.length || !this._findCondition('machines')){
                    return ids;
                }
                else {
                    ids = this.conditions.find(function(c){return c.type == "machines"}).ids;
                }
                return ids;
            },
            condition: function(m) {
                var fulfillsAge = true,
                    fulfillsCost = true;

                if (this._findCondition('age')){
                    fulfillsAge = m.created && m.created.trim() != "" ? moment().diff(m.created, 'minutes') > this.schedule.conditions.find(function(con){
                            return con.type == 'age';
                        }).minutes : false;
                }
                if (this._findCondition('cost__monthly')){
                    fulfillsCost = m.cost && m.cost.monthly ? m.cost.monthly > this.schedule.conditions.find(function(con){
                            return con.field == 'cost__monthly';
                        }).value : false;
                }

                if (this.isSpecificMachines) {
                    return this.isSelectedMachine(m.id) && fulfillsAge && fulfillsCost;
                }
                else if (this.isMachinesWithTags) {
                    return this.machineHasTag(m) && fulfillsAge && fulfillsCost;
                }
                return false;
            },
            isSelectedMachine: function(machineId) {
                return !this.schedule.conditions || !this.schedule.conditions.find(function(c){return c.type == "machines"}) ? false : this.schedule.conditions.find(function(c){return c.type == "machines"}).ids.indexOf(machineId) > -1;
            },
            machineHasTag: function(m) {
                var exists = false;
                for (var i = 0; i < m.tags.length; i++){
                    var scheduleTags = this.schedule.conditions.find(function(c){return c.type == "tags"}).tags;

                    if (scheduleTags.hasOwnProperty(m.tags[i].key)){
                        if (!scheduleTags[m.tags[i].key] && !m.tags[i].value){
                            exists = true;
                            break;
                        }
                        else if (scheduleTags[m.tags[i].key] == m.tags[i].value){
                            exists = true;
                            break;
                        }
                    }
                }
                return exists;
            },
            toggleEnable: function(){
                this.lastrequestedaction = 'run';
                this.$.editToggleSchedule.body = {task_enabled: !this.schedule.task_enabled};
                this.$.editToggleSchedule.headers["Content-Type"] = 'application/json';
                this.$.editToggleSchedule.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.editToggleSchedule.generateRequest();
            },
            _handleScheduleEditToggleResponse: function() {
                var message;
                if (this.lastrequestedaction == "enable") {
                    message = !this.schedule.task_enabled ? 'Enabling schedule..' : 'Disabling schedule..'
                }
                else if (this.lastrequestedaction == "run") {
                    message = 'Run request sent successfully.';   
                }
                this.fire('toast', { msg: message, duration: 3000 });
            },
            _handleScheduleEditToggleError: function(e) {
                console.log('_handleScheduleEditToggleError',e);
                var message = e.detail.request.xhr.response;
                this.fire('toast', { msg: message, duration: 5000 });
                this.$.scheduleEnabled.setAttribute('checked', this.schedule.task_enabled);
            },
            _computeDateFromNow: function(time) {
                return moment.utc(time).local().fromNow();
            },
            _computeAbsoluteDateText: function(time) {
                return moment(time).isValid() ? moment.utc(time).local().format("MMMM D YYYY HH:mm:ss") : "";
            },
            _selectDate: function(e) {
                var field = e.target.dataset.field;
                console.log('selectDate',e, e.target.dataset.field);

                if (field) {
                    if (moment(this.schedule[field]).isValid()){
                        this.$.pickDate.date = moment.utc(this.schedule[field]).local().toDate();
                        this.$.pickTime.time = moment.utc(this.schedule[field]).local().format('hh:mm a').toString();
                    }
                    else {
                        this.$.pickDate.date = new Date();
                        this.$.pickTime.time = moment().format('hh:mm a').toString();
                    }
                    this.expError = false;
                    this.$.dateTimePickersApplyButton.setAttribute('data-field', field);
                    this.$.dateTimePickers.open();
                }
            },
            _applyDateTime: function(e) {
                var payload = {};
                var field = e.target.dataset.field;
                if (field){
                    if (!this.neverExpire){
                        var date = moment(this.$.pickDate.date).format('YYYY-MM-DD');
                        var combinedDate = date +" "+ moment(this.$.pickTime.time, 'hh:mm:ss A').format("HH:mm:ss")
                        payload[field] = moment(combinedDate).utc().format('YYYY-MM-DD HH:mm:ss').toString()
                    }
                    else {
                        payload[field] = "";
                    }
                    // we need to reset start if hasExpired and expires if start has passed
                    if (this.hasExpired) {
                        if (field == "start_after") {
                            payload.expires = "";
                        }
                        else if (field == "expires" && (moment().diff(moment.utc(this.schedule.start_after).local()) > 0 || this.schedule.start_after == "")) {
                            payload.start_after = "";
                        }
                    }
                    this.$.editExpirationSchedule.body = payload;
                    this.$.editExpirationSchedule.headers["Content-Type"] = 'application/json';
                    this.$.editExpirationSchedule.headers["Csrf-Token"] = CSRF_TOKEN;
                    this.$.editExpirationSchedule.generateRequest();

                    this.expError = false;
                }
            },
            _handleScheduleEditExpirationResponse: function() {
                var message = 'Updating date...';
                this.fire('toast', { msg: message, duration: 3000 });

                this.$.dateTimePickers.close();
                this.expError = false;
                this.neverExpire = false;
            },
            _handleScheduleEditExpirationError: function(e) {
                console.log('_handleScheduleEditToggleError',e);
                var message = e.detail.request.xhr.response;
                this.fire('toast', { msg: message, duration: 5000 });
                this.expError = true;

                this.$.errormsg.textContent = e.detail.request.xhr.responseText;
            },
            _changeCondition: function() {
                this.$.editScheduleCondition._openEditScheduleModal();
            },
            _editTask: function() {
                this.$.editScheduleTask._openEditScheduleModal();
            },
            _runOnceDialog: function() {
                this._showDialog({
                    title: 'Run once now?',
                    body: "The schedule will execute once and then continue as planned." ,
                    danger: false,
                    reason: "schedule.run",
                    action: 'run'
                });
            },
            _computeTagsArray: function(conditions, isMachinesWithTags ){
                console.log('_computeTagsArray');
                if (this.isMachinesWithTags && this.schedule.conditions) {
                    var tagsCond = this.schedule.conditions.find(function(c){
                        return c.type == 'tags'
                    });
                    if (tagsCond) {
                        var tags = tagsCond.tags;

                        var arrTags = Object.keys(tags); 
                        for (var i=0; i < arrTags.length; i++) {
                            var t = arrTags[i];
                            if (tags[t] != null && tags[t].trim() != '') {
                                arrTags[i] = arrTags[i]+'='+tags[t];
                            }
                        }
                        return arrTags;
                    }
                }
            },
            _editMaxRunCount: function(e){
                this.$.editMaxRunCount._openEditScheduleModal();
            },
            _hideRunNow: function(hasExpired, max_run_count, total_run_count) {
                return hasExpired || this.schedule.max_run_count == this.schedule.total_run_count;
            },
            // redirect events
            selectAction: function(e) {
                e.stopImmediatePropagation();
                if (this.querySelector('machine-actions')) {
                  this.querySelector('machine-actions').selectAction(e);
                }
            } 
        });
    </script>
</dom-module>
