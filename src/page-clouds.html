<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/mist-list/mist-list.html">

<link rel="import" href="helpers/owner-filter-behavior.html">

<link rel="import" href="clouds/cloud-add.html">
<link rel="import" href="clouds/cloud-page.html">
<link rel="import" href="clouds/cloud-actions.html">

<link rel="import" href="helpers/mist-lists-behavior.html">
<link rel="import" href="helpers/owner-filter-behavior.html">
<link rel="import" href="mist-actions.html">

<dom-module id="page-clouds">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <app-route route="{{route}}" pattern="/:cloud" data="{{data}}"></app-route>

    <template is="dom-if" if="[[_isListActive(route.path)]]" restamp>
      <mist-list id="cloudsList" apiurl="/api/v1/clouds" selectable resizable column-menu multi-sort
        items="[[model.cloudsArray]]" selected-items="{{selectedItems}}"
        renderers=[[_getRenderers()]] frozen=[[_getFrozenLogColumn()]] visible=[[_getVisibleColumns()]]
        route={{route}} user-filter=[[model.sections.clouds.q]] primary-field-name="id" filter-method="[[_ownerFilter()]]"
        hidden$=[[!_isListActive(route.path)]]>
        <mist-actions slot="action-buttons" actions="[[actions]]" type="cloud" items="[[selectedItems]]" model="[[model]]"></mist-actions>
        <cloud-actions slot="actions" items="[[selectedItems]]" actions="{{actions}}" user="[[model.user.id]]" members="[[model.membersArray]]" org="[[model.org]]"></cloud-actions>
        <p slot="no-items-found">No clouds found.</p>
      </mist-list>
    </template>
    <div class="absolute-bottom-right">
        <paper-fab id="cloudAdd" icon="add" on-tap="_addResource"></paper-fab>
    </div>
    <cloud-add providers="[[providers]]" keys="[[model.keysArray]]" section="[[model.sections.clouds]]" clouds="[[model.cloudsArray]]"
      enable-monitoring="[[enableMonitoring]]" hidden$=[[!_isAddPageActive(route.path)]] portal-name=[[portalName]] docs=[[docs]] org="[[model.org]]" enable-billing=[[enableBilling]]></cloud-add>
    <cloud-page model="[[model]]" cloud="[[cloud]]" resource-id="[[data.cloud]]" section="[[model.sections.clouds]]" hidden$=[[!_isDetailsPageActive(route.path)]]></cloud-page>

  </template>

  <script>
    Polymer({
      is: 'page-clouds',
      behaviors: [
        mistListsBehavior,
        ownerFilterBehavior
      ],
      listeners: {
        'select-action': 'selectAction',
      },
      properties: {
        model: Object,
        data: Object,
        selectedItems: Array,
        enableMonitoring: Boolean,
        providers: {
          type: Object,
          value: PROVIDERS
        },
        enableBilling: Boolean,
        cloud: {
          type: Object,
          computed: '_getCloud(data.cloud, model.clouds)'
        },
        actions: {
            type: Array,
            notify: true
        },
        selectedItems: {
            type: Array,
            notify: true
        }
      },

      attached: function () {

      },
      _getFrozenLogColumn: function () {
        return ['title'];
      },

      _getVisibleColumns: function () {
        var ret = ['state', 'provider', 'region', 'machines', 'volumes', 'locations', 'id', 'tags'];
        if (this.model.org && this.model.org.ownership_enabled == true)
          ret.splice(ret.length-1,0,'owned_by');
        return ret;
      },

      _getRenderers: function(keys) {
          var _this = this;
          return {
              'title': {
                  'body': function(item, row) {
                      return '<strong class="name">'+ item + '</strong>';
                  }
              },
              'machines': {
                  'body': function(item, row) {
                    return item && Object.keys(item).length || 0;
                  }
              },
              'volumes': {
                  'body': function(item, row) {
                    return item && Object.keys(item).length || 0;
                  }
              },
              'locations': {
                  'body': function(item, row) {
                    return item && Object.keys(item).length || 0;
                  }
              },
              'owned_by': {
                  'title': function (item, row) {
                      return 'owner';
                  },
                  'body': function (item, row) {
                      return _this.model.members[item] ? _this.model.members[item].name || _this.model.members[item].email : '';
                  }
              },
              'created_by': {
                  'title': function (item, row) {
                      return 'created by';
                  },
                  'body': function (item, row) {
                      return _this.model.members[item] ? _this.model.members[item].name || _this.model.members[item].email : '';
                  }
              },
              'tags': {
                'body': function (item, row) {
                  var tags = item,
                    display = "";
                  for (key in tags) {
                    display += "<span class='tag'>" + key;
                    if (tags[key] != undefined && tags[key] != "")
                      display += "=" + tags[key];
                    display += "</span>";
                  }
                  return display;
                }
              }
          }
      },

      _isAddPageActive: function (path) {
        return path == '/+add';
      },

      _isListActive: function (path) {
        if (path && this.querySelector('cloud-page'))
          this.querySelector('cloud-page').updateState();
        return !path;
      },

      _isDetailsPageActive: function (path) {
        return path && path != '/+add';
      },
      _getCloud: function (id) {
        if (this.model.clouds)
          return this.model.clouds[id];
      },
      _addResource: function(e) {
          this.fire('go-to', {url: this.model.sections.clouds.add});
      },
      // redirect events
      selectAction: function (e) {
        e.stopImmediatePropagation();
        if (this.querySelector('cloud-actions')) {
          this.querySelector('cloud-actions').selectAction(e);
        }
      }

    });
  </script>
</dom-module>