<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<link rel="import" href="balance-chart.html">
<link rel="import" href="plan-item.html">
<link rel="import" href="plan-purchase.html">

<dom-module id="plans-list">
    <template>
        <style is="custom-style" include="shared-styles">
        :host {
            display: block;
        }

        :host paper-material {
            display: block;
            padding: 0;
        }

        .plans {
            padding-left: 8px;
            padding-right: 8px;
            @apply(--layout-horizontal);
            @apply(--layout-wrap);
        }

        .plan {
            @apply(--layout-flex);
            @apply(--shadow-elevation-2dp);
            margin: 8px;
        }
        .grid-row {
            padding: 24px;
        }

        .head {
            margin-bottom: 16px;
        }

        h2.title {
            font-weight: 500;
        }

        h2.title,
        h2.title~p {
            margin-top: 0;
            margin-bottom: 0;
        }
        .add-card {
            cursor: pointer;
        }
        .rates {
            font-size: .9em;
        }
        .balance {
            font-size: 2em;
        }
        .balance sub,
        .balance sup {
            font-size: .6em;
            font-weight: 300;
        }
        .balance sub {
            vertical-align: baseline;
        }
        .navigator {
            display: flex;
        }
        .navigator paper-button {
            font-size: .9em;
            background-color: #eee !important;
            margin: 8px !important;
        }
        .navigator paper-button.active{
            color: var(--accent-color) !important;
        }
        balance-chart {
            margin-top: 20px;
        }
        </style>
        <paper-material>
            <div class="grid-row">
                <div class="xs12 head">
                    <h2 class="title">Your current billing status</h2>
                </div>
                <div class="plans xs12 l6">
                    <plan-item plan="[[org.current_plan]]" is-current="true" index="0" class="plan" org="[[org]]"></plan-item>
                </div>
                <div class="xs12 l6" hidden>
                    <p hidden$="[[!org.current_plan.promo_code.description]]">Your current plan offers you: [[org.current_plan.promo_code.description]]</p>
                    <p>For questions and other information contact us at <a href="mailto:sales@mist.io">sales@mist.io</a></p>
                </div>
                <div class="xs12 l6">
                    <div class="navigator">
                        <paper-button on-tap="_showRates" class="simple">view your balance</paper-button>
                        <paper-button on-tap="_showRates" class="simple active">view rates</paper-button>
                    </div>
                    <div class="balance text-center" hidden$="[[showRates]]">
                        <balance-chart org="[[org]]" user="[[user]]" plans="[[plans]]"></balance-chart>
                    </div>
                    <div class="rates" hidden$="[[!showRates]]">
                        <h2><strong>Pay As You Go Rates</strong></h2>
                        <p>Rates apply if <span hidden$="[[org.current_plan.title]]">free tier</span><span hidden$="[[!org.current_plan.title]]">plan</span> limits are exceeded. <br/>High watermark, pro-rated daily.</p>
                        <ul>
                            <li> <strong><sup>$</sup>2/mo</strong> per additional vCPU</li>
                            <li> <strong><sup>$</sup>5/mo</strong> per additional 1M datapoints/day </li>
                            <li> <strong><sup>$</sup>5/mo</strong> per additional 100k rule checks/day</li>
                            <li> <strong><sup>$</sup>5/mo</strong> per additional 1M API requests/day</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="grid-row">
                <div class="xs12 head">
                    <h2 class="title">Prepaid Plans</h2>
                </div>
                <div class="plans xs12">
                    <template is="dom-repeat" items=[[plans]] as="plan">
                        <plan-item user="[[user]]" plan="[[plan]]" index="[[index]]" class="plan" org="[[org]]"></plan-item>
                    </template>
                </div>
            </div>
        </paper-material>
        <paper-material>
            <div class="grid-row">
                <div class="xs12 head">
                    <h2 class="title">Custom plan</h2>
                    <p>Don't see a plan that meets your requirements? <a href="mailto:sales@mist.io">Contact sales.</a></p>
                </div>
            </div>
        </paper-material>
        <plan-purchase id="purchasePlan" org="[[org]]"></plan-purchase>
        <plan-purchase id="addCard" org="[[org]]" add-card></plan-purchase>
    </template>
    <script>
        Polymer({
            is: 'plans-list',

            properties: {
                isOverUsing: Boolean,
                user: {
                    type: Object
                },
                org: {
                    type: Object
                },
                plans: {
                    type: Array,
                    computed: 'computePlans(user, org)'
                },
                showBalance: {
                    type: Boolean,
                    computed: '_computeShowBalance(org.current_plan)'
                },
                showRates: {
                    type: Boolean,
                    value: false
                }
            },
            listeners: {
                'plan-selected': 'purchasePlan',
                'error-on-cancel-plan': 'showErrorsOfCancel',
                'add-card': 'addCard',
                'update-payment-method': 'addCard'
            },
            attached: function(){
            },
            computeIsCurrent: function(plan, org) {
                if (this.org.current_plan) {
                    return plan.title == this.org.current_plan.title ? true : false;
                } else {
                    return false;
                }
            },
            _showRates: function() {
                this.set('showRates', !this.showRates);
            },
            _computeShowBalance: function(current_plan) {
                // TEST
                return true;
                // return this.org.current_plan.title && this.org.current_plan.id; //&& this.org.current_plan.balance ?
            },
            computePlans:  function(user, org){
                if (!this.org.available_plans)
                    return [];
                return this.org.available_plans;
            },
            _computeReadableDate: function(date) {
                return date ? moment(date * 1000).format("MMMM Do YYYY") : '...';
            },
            purchasePlan: function(e){
                this.$.purchasePlan.plan = e.detail.plan;
                this.$.purchasePlan.open();
            },
            addCard: function(e){
                this.$.addCard.open();
            },
            showErrorsOfCancel: function(errormessage){

            }
        });
    </script>
</dom-module>
