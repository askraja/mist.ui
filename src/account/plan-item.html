<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../helpers/dialog-element.html">

<dom-module id="plan-item">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                box-sizing: border-box;
            }

            :host[is-current] {
                color: #ffffff;
                background-color: #039BE5;
            }

            :host[is-current] paper-button {
                color: #039BE5 !important;
                background-color: #ffffff !important;
            }

            hr {
                border: none;
                border-bottom: 1px solid rgba(0,0,0,0.13);
            }

            h2 {
                font-weight: bold;
                text-transform: uppercase;
            }

            #select {
                color: #ffffff;
                background-color: #039BE5;
            }
            .plan {
                text-align: center;
            }
            #cancelButton, #updatePaymentMethodButton {
                font-size: 0.8em;
                margin-top: 16px;
            }
            paper-spinner-lite.white {
                --paper-spinner-color: #fff;
            }
            .title {
                color: #fff;
                text-transform: uppercase;
                padding: 20px 0;
                font-size: 18px;
            }
            .current {
                background-color: #2196F3;
            }
            .bg-0 {
                background-color: #999;
            }
            .bg-1 {
                background-color: #777;
            }
            .bg-2 {
                background-color: #555;
            }
            .bg-3 {
                background-color: #222;
            }
            .plan {
                margin-bottom: 50px;
                overflow: auto;
            }
            .plan, .plan > * {
                box-sizing: border-box;
                margin: 0;
            }
            .plan paper-button {
                margin: 0 !important;
                font-size: 14px;
                height: 2rem;
                width: auto;
            }
            .plan-body-item {
                padding: 30px 10px 30px 10px;
            }
        @media only screen and (max-width: 600px) {
            .plan-body-item {
                min-height: 50px;
            }
        }
        
        .plan-body-item + .plan-body-item {
            border-top: 1px solid #d4d4d4;
        }
        
        .plan-body-item:last-child {
            border-bottom: 1px solid #d4d4d4;
        }
        
        .plan-body-item.highlight {
            background-color: #f2f2f2;
        }
        
        .plan-body-item * {
            width: 100%;
        }

        .plan-body-item:not(:first-child) {
            padding: 0 10px;
        }
        
        .valign {
            display: block;
        }
        
        .price {
            font-weight: 700;
            line-height: 1;
            padding: 0;
            font-size: 1.56rem;
        }
        
        .price sub,
        .price sup {
            font-size: .6em;
            font-weight: 300;
        }

        .price sub {
            vertical-align: baseline;
        }

        .old {
            padding-bottom: 30px;
        }
        .payg-info {
            margin: 24px 24px 16px 24px;
            display: block;
        }
        span#vcpus, span#datapoints, span#rulechecks, span#apirequests, span#retention {
            border-bottom: 1px dashed #fff;
        }
        paper-tooltip::content #tooltip{
            font-size: 14px;
        }
        </style>
        <div class="plan old" hidden$="[[plan.vcpu_limit]]">
            <h2>[[plan.title]]
                <!-- any plan but payg has title -->
                <span hidden$="[[plan.title]]">Pay As You Go</span>
            </h2>
            <hr>
            <!-- regular plans -->
            <p>[[priceText]]
                <!-- any plan but payg has title -->
                <span class="payg-info" hidden$="[[plan.title]]">
                    <strong>FREE</strong> for up to

                    10 <span id="vcpus">vCPUs</span>,
                    1M <span id="datapoints">datapoints/day</span>,
                    10k <span id="rulechecks">rule checks/day</span>,
                    10k <span id="apirequests">API requests/day</span>.

                    <div>1 month <span id="retention">retention</span></div>
                    <paper-tooltip for="vcpus" animation-delay="0" position="top">Total sum of physical and virtual processor cores under management.</paper-tooltip>
                    <paper-tooltip for="datapoints" animation-delay="0" position="top">Incoming metric samples and log entries.</paper-tooltip>
                    <paper-tooltip for="rulechecks" animation-delay="0" position="top">Evaluations of conditions that trigger alerts or automated actions.</paper-tooltip>
                    <paper-tooltip for="apirequests" animation-delay="0" position="top">Invokations of the Mist.io API by any member of your organization.</paper-tooltip>
                    <paper-tooltip for="retention" animation-delay="0" position="top">Historic data within the retention window will be accesible.</paper-tooltip>
                </span>
                <span hidden$="[[plan.title]]">
                    <br/>
                    <br/>
                    <paper-button class="blue" raised on-tap="_selectPayg" hidden$="[[!hasCard]]">Enable</paper-button>
                </span>
            </p>
            <div hidden$="[[enterprise]]">
                <p>
                    <!-- any plan but payg has title -->
                    <span hidden$="[[!plan.title]]">[[descriptionText]]</span>
                </p>
            </div>
            <!-- if plan is enterprise but not current. show text -->
            <p hidden$="[[!enterprise]]">
                Contact us for your custom Enterprise plan of more than 300 machines
            </p>
            <div hidden$="[[!enterprise]]">
                tel: +1-650-605-3299 <br/>
                <a href="mailto:sales@mist.io">sales@mist.io</a>
            </div>

            <!-- regular plans -->
            <p hidden$="[[!plan.promo]]">[[plan.promo.description]]</p>

            <!-- plan is canceled -->
            <template is="dom-if" if="[[plan.expiration]]">
                Your plan will expire on [[_computeReadableDate(plan.expiration)]]. <br/>
            </template>

            <template is="dom-if" if="[[showPurchase(plan, isCurrent)]]">
                <paper-button id="select" class="btn-block submit-btn blue" on-tap="_selectPayg" hidden$="[[isFreePlan]]">[[buttonText]]</paper-button>
            </template>

            <!-- is current plan, not cancelled-->
            <div hidden$="[[!showCancel(plan,org)]]">
                <paper-button id="cancelButton" on-tap="_cancelPlan" hidden$="{{loadingCancel}}">Cancel Plan</paper-button>
                <div hidden$="{{!loadingCancel}}">
                    Canceling Plan <br/><br/>
                    <paper-spinner-lite class="white" active="{{loadingCancel}}"></paper-spinner-lite>
                </div>
            </div>

        </div>

        <div class="plan" hidden$="[[!plan.vcpu_limit]]">
            <div class$="[[bgclass]]">
                [[plan.title]]
            </div>
            <div class="plan-body">
                <div class="plan-body-item">
                    <div class="valign">
                        <h2 class="price"><sup>$</sup>[[plan.price]]<sub>/mo.</sub></h2>
                        <paper-button class="blue" raised on-tap="_selectPlan" hidden$="[[isCurrent]]">Purchase</paper-button>
                        <!-- <div class="selected" hidden$="[[!isCurrent]]"><iron-icon icon="icons:check"></iron-icon> selected</div>
                        <a class="cancel regular blue-link" on-tap="_cancelPlan" hidden$="[[!isCurrent]]">Cancel plan</a> -->
                    </div>
                </div>
                <div class="plan-body-item">
                    <p class="valign">[[plan.vcpu_limit]] vCPUs</p>
                    <p class="valign">[[plan.datapoint_limit]] datapoints/day</p>
                    <p class="valign">[[plan.checks_limit]] rule checks/day</p>
                    <p class="valign">[[plan.retention]] retention</p>
                </div>
            </div>
        </div>

        <dialog-element id="plancancel"></dialog-element>
        <iron-ajax id="cancelPlanAjaxRequest"
                        url="/api/v1/org/[[org.id]]/billing"
                        method="DELETE"
                        loading="{{loadingCancel}}"
                        on-response="_handleCancelAjaxResponse"
                        on-error="_handleCancelAjaxError"
                        handle-as="xml"></iron-ajax>

    </template>
    <script>
            Polymer({
                is: 'plan-item',

                properties: {
                    plan: {
                        type: Object
                    },
                    org: {
                        type: Object
                    },
                    index: {
                        type: Number,
                        value: 0
                    },
                    isFreePlan: {
                        type: Boolean,
                        computed: "_computeIsFreePlan(plan.title)"
                    },
                    isCurrent: {
                        type: Boolean,
                        computed: '_computeIsCurrent(plan,org)',
                        reflectToAttribute: true
                    },
                    priceText: {
                        type: String,
                        computed: '_computePriceText(plan.price)'
                    },
                    descriptionText: {
                        type: String,
                        computed: '_computeDescriptionText(plan)'
                    },
                    discountedPriceText: {
                        type: String,
                        computed: '_computeDiscountedPriceText(plan.promo)'
                    },
                    enterprise: {
                        type: Boolean,
                        computed: "_computeIsEnteriprise(plan.title, org)",
                        value: false
                    },
                    buttonText: {
                        type: String,
                        computed: '_computeButtonText(plan, org.current_plan)'
                    },
                    loadingCancel: {
                        type: Boolean,
                        value: false
                    },
                    bgclass: {
                        type: String,
                        computed: '_computeBgClass(plan, org.current_plan)'
                    }
                },
                listeners: {
                    'confirmation': '_cancelPlanConfirmed',
                },
                _computeBgClass: function(plan, current) {
                    if (!this.isCurrent) {
                        if (plan.title == "Small")
                            return "title bg-1";
                        else if (plan.title == "Medium")
                            return "title bg-2";
                        else if (plan.title == "Large")
                            return "title bg-3";
                    }
                },
                _computePriceText: function(price) {
                    return price != null ? '$' + price + '/mo' : '';
                },
                _computeIsCurrent: function(plan,org){
                    return plan.title == this.org.current_plan.title && plan.id == this.org.current_plan.id;
                },
                _computeIsFreePlan: function(planTitle){
                    return planTitle == "Free";
                },
                _computeDescriptionText: function(plan) {
                    var monitoringFor = '';
                    if (this.plan.monitor_limit) {
                        monitoringFor = " and monitoring for "+ this.plan.monitor_limit +" of them";
                    }
                    return !this.plan.description || this.plan.description == "" ? 'up to ' + this.plan.machine_limit + '  machines'+monitoringFor : this.plan.description;
                },
                _computeDiscountedPriceText: function(promo) {
                    if (promo) {
                        var newPrice = Math.round(price * (1 - (promo.discount / 100)));
                        return '$' + newPrice + '/mo';
                    }
                    return '';
                },
                _computeReadableDate: function(date) {
                    return date ? moment.utc(date * 1000).format("MMMM Do YYYY") : date;
                },
                _addCard: function(e) {
                    this.fire('add-card');
                },
                _selectPayg: function(e) {
                    this.fire('plan-selected');
                },
                _selectPlan: function(e) {
                    this.fire('plan-selected', {plan: this.plan});
                },
                _triggerInfo: function() {
                    console.log('info popup');
                },
                _computeIsEnteriprise: function(title, org){
                    return this.plan.title && this.plan.title == "Enterprise" && !this.org.enterprise_plan.title;
                },
                _cancelPlan: function(){
                    this._showDialog({
                        title: 'Cancel current plan',
                        body: "Your plan will expire at the end of your monthly subscription." ,
                        danger: true,
                        reason: "plan.cancel",
                        action: "Cancel Your plan",
                        undo: "not yet"
                    });
                },
                _updatePaymentMethod: function() {
                    this.fire('update-payment-method');
                },
                _showDialog: function(info) {
                    var dialog = this.querySelector('dialog-element');
                    for (var i in info) {
                        dialog[i] = info[i];
                    }
                    dialog._openDialog();
                },
                _cancelPlanConfirmed: function(e){
                    console.log('_cancelPlanConfirmed', e);
                    var reason = e.detail.reason,
                        response = e.detail.response;

                    if (response.confirmed && reason == "plan.cancel") {
                        this.$.cancelPlanAjaxRequest.headers["Content-Type"] = 'application/json';
                        this.$.cancelPlanAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                        this.$.cancelPlanAjaxRequest.generateRequest();
                    }
                },
                _handleCancelAjaxResponse: function(e){
                    this.fire('toast',{msg:'You cancelled your plan. ',duration:3000});
                },

                _handleCancelAjaxError: function(e){
                    this.fire('error-on-cancel-plan',{error: e.detail.request.xhr.responseText});
                },
                _computeButtonText: function(plan, org){
                    if (this.plan.title && this.org.current_plan.machine_limit > plan.machine_limit){
                        console.log('UP / DOWN', this.org.current_plan.machine_limit, plan.machine_limit)
                        return 'Downgrade';
                    }
                    else if (!this.org.current_plan.machine_limit || this.org.current_plan.machine_limit < plan.machine_limit){
                        return 'Upgrade';
                    }
                    else {
                        return "Purchase";
                    }
                },
                showCancel: function(plan, org){
                    return this.plan.title && this.org.current_plan.title == plan.title && !this.org.current_plan.expiration;
                },
                showPurchase: function(planexpiration, isCurrent) {
                    return (!this.isCurrent && this.plan.price != null) || (this.isCurrent && this.org.current_plan.expiration); 
                }
            });
    </script>
</dom-module>
