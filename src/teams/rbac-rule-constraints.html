<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../element-for-in/element-for-in.html">
<link rel="import" href="../helpers/dialog-element.html">

<dom-module id="rbac-rule-constraints">
    <template>
        <style include="shared-styles tags-and-labels">
        :host {
            display: flex;
            align-items: center;
        }

        paper-dropdown-menu {
            width: 150px;

            --paper-dropdown-menu-input: {
                text-transform: uppercase;
            }

            --paper-input-container-underline: {
                /*display: none;*/
                opacity: 0.32;
            }
        }

        paper-dropdown-menu.short {
            /*width: 80px;*/
            margin-right: 16px;
        }

        paper-input {
            vertical-align: middle;
        }

        .flex {
            display: inline-flex;
        }

        .tag {
            vertical-align: middle;
        }

        paper-input {
            --paper-input-container-underline {
                opacity: 0.32;
            }
        }

        .tag iron-icon {
            color: #fff;
            width: 13px;
            height: 13px;
            cursor: pointer;
        }

        iron-icon.edit {
            color: inherit;
            padding: 8px;
            opacity: 0.32;
        }
        </style>
        <span hidden$="[[!showConstraints]]">
            <element-for-in content="[[rule.constraints]]"></element-for-in>
            <!-- <span hidden$=[[!rule.constraints.expiration]]><strong>Expiration: </strong>
                [[_displayJSON(rule.constraints.expiration)]]<br/>
            </span>
            <span hidden$=[[!rule.constraints.cost]]><strong>Cost: </strong>
                [[_displayJSON(rule.constraints.cost)]]<br/>
            </span>
            <span hidden$=[[!rule.constraints.count]]><strong>Count: </strong>
                [[_displayJSON(rule.constraints.count)]]<br/>
            </span>
            <span hidden$=[[!rule.constraints.cores]]><strong>Cores: </strong>
                [[_displayJSON(rule.constraints.cores)]]<br/>
            </span> -->
            <span hidden$="[[!error]]">[[error]]</span>
            <span hidden$="[[!rule.constraints]]">Edit</span>
            <iron-icon icon="editor:mode-edit" on-tap="editConstraints" class="edit"></iron-icon>
        </span>
        <dialog-element id="editConstraints" formId="editConstraints-[[index]]" fields="{{fields}}" form="{{form}}" single-column-form="[[singleColumnForm]]" inline="[[inline]]"></dialog-element>
    </template>
</dom-module>
<script>
const RBAC_CONSTRAINTS_FIELDS = [{
        name: 'constraints',
        label: 'Constraints in JSON',
        type: 'textarea',
        value: '',
        defaultValue: '',
        show: true,
        required: false,
        helptext: 'Edit the constraints in JSON format'
}]
// const RBAC_CONSTRAINTS_FIELDS = [{
//     name: 'expiration',
//     label: 'Set machine expiration constraints',
//     type: 'fieldgroup',
//     value: {},
//     defaultValue: {},
//     defaultToggleValue: false,
//     show: true,
//     required: false,
//     optional: true,
//     singleColumnForm: true,
//     inline: false,
//     subfields: [{
//             name: 'max',
//             type: 'duration_field',
//             value: '1mo',
//             defaultValue: '1mo',
//             helptext: 'Define the max machine expiration time allowed after creation',
//             required: false,
//             show: true,
//             optional: true,
//             disabled: true,
//             parentField: 'expiration',
//             valueType: 'relative',
//             options: [
//                 {val: 'months', title: 'months'},
//                 {val: 'weeks', title: 'weeks'},
//                 {val: 'days', title: 'days'},
//                 {val: 'hours', title: 'hours'},
//                 {val: 'minutes', title: 'minutes'}
//             ]
//         }, {
//             name: 'default',
//             type: 'duration_field',
//             value: '1w',
//             helptext: 'Set a default machine expiration after creation',
//             defaultValue: '1w',
//             required: false,
//             show: true,
//             optional: true,
//             disabled: true,
//             parentField: 'expiration',
//             valueType: 'relative',
//             options: [
//                 {val: 'months', title: 'months'},
//                 {val: 'weeks', title: 'weeks'},
//                 {val: 'days', title: 'days'},
//                 {val: 'hours', title: 'hours'},
//                 {val: 'minutes', title: 'minutes'}
//             ]
//         }, {
//             name: 'notify',
//             type: 'fieldgroup',
//             class: 'xs12 m12 l12',
//             label: 'Notification',
//             value: {},
//             defaultValue: {},
//             defaultToggleValue: false,
//             show: true,
//             required: false,
//             parentField: 'expiration',
//             singleColumnForm: true,
//             inline: true,
//             subfields: [{
//                 name: 'default',
//                 helptext: 'Set a default notification time before expiration',
//                 type: 'duration_field',
//                 value: '',
//                 defaultValue: '2d',
//                 required: false,
//                 show: true,
//                 optional: true,
//                 valueType: 'relative',
//                 disabled: true,
//                 parentField: 'notify',
//                 options: [
//                     {val: 'months', title: 'months'},
//                     {val: 'weeks', title: 'weeks'},
//                     {val: 'days', title: 'days'},
//                     {val: 'hours', title: 'hours'},
//                     {val: 'minutes', title: 'minutes'}
//                 ]
//             },{
//                 name: 'msg',
//                 label: 'Expiration text message',
//                 type: 'text',
//                 class: 'pad-l-32',
//                 value: '',
//                 defaultValue: '',
//                 show: true,
//                 required: false,
//                 parentField: 'notify',
//                 helptext: 'Set a message',
//             },{
//                 name: 'require',
//                 label: 'Notification',
//                 type: 'checkbox',
//                 class: 'pad-l-32',
//                 value: false,
//                 defaultValue: false,
//                 show: true,
//                 disabled: true,
//                 parentField: 'notify',
//                 required: false,
//                 helptext: 'Enable by default the notification email, before machine expiration.',
//             }]
//         }
//     ]
// }, {
//     name: 'cost',
//     label: 'Set machine cost constraints',
//     type: 'fieldgroup',
//     value: {},
//     defaultValue: {},
//     defaultToggleValue: false,
//     show: true,
//     required: false,
//     optional: true,
//     subfields: [{
//                 name: 'max_total_run_rate',
//                 label: 'max_total_run_rate',
//                 type: 'number',
//                 class: 'pad-l-32',
//                 value: '',
//                 defaultValue: '',
//                 parentField: 'cost',
//                 show: true,
//                 required: false,
//                 helptext: 'Set the max_total_run_rate',
//             },{
//                 name: 'max_team_run_rate',
//                 label: 'max_team_run_rate',
//                 type: 'number',
//                 class: 'pad-l-32',
//                 value: '',
//                 defaultValue: '',
//                 parentField: 'cost',
//                 show: true,
//                 required: false,
//                 helptext: 'Set the max_team_run_rate',
//             },{
//                 name: 'max_machine_rate',
//                 label: 'max_machine_rate',
//                 type: 'number',
//                 class: 'pad-l-32',
//                 value: '',
//                 defaultValue: '',
//                 parentField: 'cost',
//                 show: true,
//                 required: false,
//                 helptext: 'Set the max_machine_rate',
//             }]
// }, {
//     name: 'count',
//     label: 'Set machine count constraints',
//     type: 'fieldgroup',
//     value: {},
//     defaultValue: {},
//     defaultToggleValue: false,
//     show: true,
//     required: false,
//     optional: true,
//     subfields: [{
//                 name: 'max_total_machines',
//                 label: 'max_total_machines',
//                 type: 'number',
//                 class: 'pad-l-32',
//                 value: '',
//                 defaultValue: '',
//                 parentField: 'count',
//                 show: true,
//                 required: false,
//                 helptext: 'Set the max_total_machines',
//             },{
//                 name: 'max_team_machines',
//                 label: 'max_team_machines',
//                 type: 'number',
//                 class: 'pad-l-32',
//                 value: '',
//                 defaultValue: '',
//                 parentField: 'count',
//                 show: true,
//                 required: false,
//                 helptext: 'Set the max_team_machines',
//             },{
//                 name: 'max_user_machines',
//                 label: 'max_user_machines',
//                 type: 'number',
//                 class: 'pad-l-32',
//                 value: '',
//                 defaultValue: '',
//                 parentField: 'count',
//                 show: true,
//                 required: false,
//                 helptext: 'Set the max_user_machines',
//             }]
// },  {
//     name: 'cores',
//     label: 'Set machine cores constraints',
//     type: 'fieldgroup',
//     value: {},
//     defaultValue: {},
//     defaultToggleValue: false,
//     show: true,
//     required: false,
//     optional: true,
//     subfields: [{
//                 name: 'max_total_cores',
//                 label: 'max_total_cores',
//                 type: 'number',
//                 class: 'pad-l-32',
//                 value: '',
//                 defaultValue: '',
//                 parentField: 'cores',
//                 show: true,
//                 required: false,
//                 helptext: 'Set the max_total_cores',
//             },{
//                 name: 'max_team_cores',
//                 label: 'max_team_cores',
//                 type: 'number',
//                 class: 'pad-l-32',
//                 value: '',
//                 defaultValue: '',
//                 parentField: 'cores',
//                 show: true,
//                 required: false,
//                 helptext: 'Set the max_team_cores',
//             },{
//                 name: 'max_user_machines',
//                 label: 'max_user_machines',
//                 type: 'number',
//                 class: 'pad-l-32',
//                 value: '',
//                 defaultValue: '',
//                 parentField: 'cores',
//                 show: true,
//                 required: false,
//                 helptext: 'Set the max_user_cores',
//             }]
// }
// ]

    Polymer({
        is: 'rbac-rule-constraints',
        properties: {
            model: {
                type: Object,
            },
            rule: {
                type: Object,
                notify: true
            },
            index: {
                type: Number,
            },
            showConstraints: {
                type: Boolean,
                value: false,
                computed: '_computeShowConstraints(rule.*)'
            },
            fields: {
                type: Array,
                value: function(){
                    return RBAC_CONSTRAINTS_FIELDS;
                }
            },
            singleColumnForm: {
                type: Boolean,
                value: true
            },
            inline: {
                type: Boolean,
                value: true
            },
            error: {
                type: String,
                value: ''
            }
        },

        listeners: {
            'keyup': 'hotkeys',
            'confirmation': '_updateRuleConstraints'
        },
        _computeShowConstraints: function(rule) {
            // emty strings for ALL
            return ["machine", ""].indexOf(this.rule.rtype) > -1 && ["create",""].indexOf(this.rule.action)>-1;
        },

        hotkeys: function(e) {
            // if 'enter'
            if (e.keyCode === 13) {
                this.$.inputField.blur();
            }
        },
        editConstraints: function(e) {
            this.error = "";
            this._mapValuesToFields();
            this._showDialog({
                title: 'Edit constraints',
                reason:'edit.constraints',
                hideText: true,
                fields: this.fields,
                action: 'save'
            });
        },
        _showDialog: function(info) {
            var dialog = this.shadowRoot.querySelector('dialog-element#editConstraints');
            if (info) {
                for (var i in info) {
                    dialog[i] = info[i];
                }
            }
            dialog._openDialog();
        },
        _updateRuleConstraints: function(e) {
            // update rule.constraints
            var reason = e.detail.reason,
                response = e.detail.response;
            if (response == 'confirm' && reason == "edit.constraints") {
                var newConstraints;
                try {
                    newConstraints = JSON.parse(this.fields[0].value);
                    this.set('rule.constraints', newConstraints);
                    this.fire('update-constraints');
                } catch (e){
                    this.error = "JSON parse error";
                    console.error(e);
                }
            }
        },
        _displayJSON: function(json){
            return json && JSON.stringify(json);
        },
        _mapValuesToFields: function() {
            // fill in fields with constraints corresponding values
            this.set('fields.0.value', JSON.stringify(this.rule.constraints));

            // this._updateLoop(this.fields,'fields.', 'constraints');
            // this.notifyPath('fields');
        },
        _updateLoop: function(fields, baseFieldPath, valuePath){
            // loop through fields 
            for (var i=0; i < fields.length; i++) {
                var newFieldpath = baseFieldPath +''+ i +'.', 
                    newValuePath = valuePath +'.'+ fields[i].name;
                if (fields[i].type == "fieldgroup") {
                    if (JSON.stringify(this.get('rule.' + newValuePath)) && 
                        JSON.stringify(this.get('rule.' + newValuePath)) != '{}'){
                        this.set(newFieldpath + 'defaultToggleValue', true);
                    }
                    this._updateLoop(fields[i].subfields, newFieldpath+'subfields.', newValuePath);
                }
                this._updateFieldValue(newFieldpath, newValuePath);
            }
        },
        _updateFieldValue: function(fieldpath, valuePath) {
            this.set(fieldpath + 'value', this.get('rule.' + valuePath));
            this.set(fieldpath + 'defaultValue', this.get('rule.' + valuePath));
            this.set(fieldpath + 'disabled', false);
        }
    });
</script>