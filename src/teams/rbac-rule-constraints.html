<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../element-for-in/element-for-in.html">
<link rel="import" href="../helpers/dialog-element.html">

<dom-module id="rbac-rule-constraints">
    <template>
        <style include="shared-styles tags-and-labels">
        :host {
            display: flex;
            align-items: center;
        }

        paper-dropdown-menu {
            width: 150px;

            --paper-dropdown-menu-input: {
                text-transform: uppercase;
            }

            --paper-input-container-underline: {
                /*display: none;*/
                opacity: 0.32;
            }
        }

        paper-dropdown-menu.short {
            /*width: 80px;*/
            margin-right: 16px;
        }

        paper-input {
            vertical-align: middle;
        }

        .flex {
            display: inline-flex;
        }

        .tag {
            vertical-align: middle;
        }

        paper-input {
            --paper-input-container-underline {
                opacity: 0.32;
            }
        }

        .tag iron-icon {
            color: #fff;
            width: 13px;
            height: 13px;
            cursor: pointer;
        }

        iron-icon.edit {
            color: inherit;
            padding: 8px;
            opacity: 0.32;
        }
        </style>
        <span hidden$="[[!showConstraints]]">
            <element-for-in content="[[rule.constraints]]"></element-for-in>
            <iron-icon icon="editor:mode-edit" on-tap="editConstraints" class="edit"></iron-icon>
        </span>
        <dialog-element id="editConstraints" fields="{{fields}}" single-column-form="[[singleColumnForm]]" inline="[[inline]]"></dialog-element>
    </template>
</dom-module>
<script>
const RBAC_CONSTRAINTS_FIELDS = [{
    name: 'expiration',
    label: 'Set expiration',
    type: 'fieldgroup',
    value: {},
    defaultValue: {},
    defaultToggleValue: false,
    show: true,
    required: false,
    optional: false,
    subfields: [{
            name: 'max',
            type: 'duration_field',
            value: '1mo',
            defaultValue: '1mo',
            helptext: 'Latest allowed machine expiration after creation',
            required: false,
            show: true,
            optional: true,
            options: [
                {val: 'months', title: 'months'},
                {val: 'weeks', title: 'weeks'},
                {val: 'days', title: 'days'},
                {val: 'hours', title: 'hours'},
                {val: 'minutes', title: 'minutes'}
            ]
        }, {
            name: 'default',
            type: 'duration_field',
            value: '1w',
            helptext: 'Default machine expiration after creation',
            defaultValue: '1w',
            required: false,
            show: true,
            optional: true,
            options: [
                {val: 'months', title: 'months'},
                {val: 'weeks', title: 'weeks'},
                {val: 'days', title: 'days'},
                {val: 'hours', title: 'hours'},
                {val: 'minutes', title: 'minutes'}
            ]
        }, {
            name: 'notify',
            type: 'fieldgroup',
            class: 'xs12 m12 l12',
            label: 'Notification',
            value: {},
            defaultValue: {},
            defaultToggleValue: false,
            show: true,
            required: false,
            singleColumnForm: true,
            subfields: [{
                name: 'default',
                helptext: 'Default notification time before expiration',
                type: 'duration_field',
                value: '',
                defaultValue: '2d',
                required: false,
                show: true,
                optional: true,
                options: [
                    {val: 'months', title: 'months'},
                    {val: 'weeks', title: 'weeks'},
                    {val: 'days', title: 'days'},
                    {val: 'hours', title: 'hours'},
                    {val: 'minutes', title: 'minutes'}
                ]
            },{
                name: 'msg',
                label: 'Expiration text message',
                type: 'text',
                value: '',
                defaultValue: '',
                show: true,
                required: false,
                helptext: '',
            },{
                name: 'require',
                label: 'Notification?',
                type: 'checkbox',
                value: true,
                defaultValue: true,
                show: true,
                required: false,
                helptext: '',
            }]
        }
    ]
}]

    Polymer({
        is: 'rbac-rule-constraints',
        properties: {
            model: {
                type: Object,
            },
            rule: {
                type: Object
            },
            index: {
                type: Number,
            },
            showConstraints: {
                type: Boolean,
                value: false,
                computed: '_computeShowConstraints(rule.*)'
            },
            fields: {
                type: Array,
                value: function(){
                    return RBAC_CONSTRAINTS_FIELDS;
                }
            },
            singleColumnForm: {
                type: Boolean,
                value: true
            },
            inline: {
                type: Boolean,
                value: true
            }
        },

        listeners: {
            'keyup': 'hotkeys'
        },

        _computeShowConstraints: function(rule) {
            // emty strings for ALL
            return ["machine", ""].indexOf(this.rule.rtype) > -1 && ["create",""].indexOf(this.rule.action)>-1;
        },

        hotkeys: function(e) {
            // if 'enter'
            if (e.keyCode === 13) {
                this.$.inputField.blur();
            }
        },
        editConstraints: function(e) {
            this._showDialog({
                title: 'Edit constraints',
                reason:' edit.contraints',
                hideText: true,
                fields: this.fields,
                action: 'save'
                // type
                // danger
                // alert
                // subscript
                // undo
                // list
            });
        },
        _showDialog: function(info) {
            var dialog = this.shadowRoot.querySelector('dialog-element#editConstraints');
            if (info) {
                for (var i in info) {
                    dialog[i] = info[i];
                }
            }
            dialog._openDialog();
        }
    });
</script>